# AlphaGenome Output Visualization

Interactive viewer for AlphaGenome predictions (.npz files) generated by the non-longevous dataset pipeline.

## ğŸ“‹ Overview

`alphagenome_output_visualization.py` is an interactive visualization tool that allows you to:

- Navigate through AlphaGenome predictions with keyboard controls
- View multiple files simultaneously with overlay mode
- Compare different output types (ATAC-seq, RNA-seq, etc.) side by side
- Analyze functional predictions across samples, SNPs, and haplotypes

## ğŸ¯ Features

### Core Features

- **Keyboard Navigation**: Fast, intuitive navigation through thousands of prediction files
- **Overlay Mode**: Superimpose multiple predictions for direct comparison
- **Group Mode**: View different output types together (ATAC + RNA-seq)
- **Automatic Discovery**: Finds all .npz files in the output directory
- **Caching**: Intelligent caching for improved performance
- **Statistics Display**: Real-time mean and standard deviation for each track

### Visualization Modes

1. **Single File Mode** (default)
   - Display one .npz file at a time
   - Up to 4 tracks per file shown as stacked subplots
   - Sample ID, SNP, haplotype, and output type in title

2. **Overlay Mode**
   - Superimpose multiple files on the same plot
   - Color-coded for easy distinction (blue, red, green, orange, etc.)
   - Interactive legend with file identifiers
   - Useful for comparing different samples or haplotypes

3. **Group Mode**
   - View multiple output types together (e.g., ATAC + RNA-seq)
   - Two display styles:
     - **Stacked**: Vertical subplots (one per output type)
     - **Overlaid**: Same plot with independent Y-axes (twinx)

## ğŸš€ Quick Start

### Basic Usage

```bash
# From build_non_longevous_dataset directory
python3 alphagenome_output_visualization.py configs/small.yaml

# From project root
python3 build_non_longevous_dataset/alphagenome_output_visualization.py \
  build_non_longevous_dataset/configs/small.yaml
```

The program will:
1. Load the YAML configuration
2. Scan for all .npz files in the `output_dir`
3. Display the first file
4. Wait for keyboard commands

### Requirements

- Python 3.8+
- matplotlib
- numpy
- pyyaml

All dependencies are included in the `genomics` conda environment.

## âŒ¨ï¸ Keyboard Controls

### Navigation

| Key | Action |
|-----|--------|
| `Space` / `â†’` | Next file |
| `â†` | Previous file |

### Overlay Controls

| Key | Action |
|-----|--------|
| `a` | Activate overlay mode (adds current file as base) |
| `A` | Deactivate overlay mode (clears all overlaid files) |

When overlay mode is active:
- The current file is added as the base layer
- Each press of `Space` advances to the next file AND adds it to the overlay
- Press `A` to clear all overlaid files and return to single-file mode

### Output Type Controls

| Key | Action |
|-----|--------|
| `d` | Next output type (atac â†’ rna_seq â†’ ...) |
| `D` | Previous output type (rna_seq â†’ atac â†’ ...) |

Switches between available output types and refreshes the file list.

### Group Mode Controls

| Key | Action |
|-----|--------|
| `g` | Activate group mode / Toggle display style (stacked â†” overlaid) |
| `G` | Deactivate group mode |

Group mode displays multiple output types together:
- First press of `g`: Activates group mode with **stacked** layout
- Subsequent presses of `g`: Toggles between **stacked** and **overlaid** layouts
- Press `G` to return to single output type mode

### Other Controls

| Key | Action |
|-----|--------|
| `q` / `ESC` | Exit program |

## ğŸ“Š Understanding the Visualizations

### Single File View

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HG00120 | rs10497191 | H1 | atac               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Track 0                    Î¼=0.1234 Ïƒ=0.0567  â”‚
â”‚  [Line plot with filled area]                   â”‚
â”‚                                                  â”‚
â”‚  Track 1                    Î¼=0.2345 Ïƒ=0.0678  â”‚
â”‚  [Line plot with filled area]                   â”‚
â”‚                                                  â”‚
â”‚  Position (bp)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Each track represents predictions for a specific tissue/cell type from AlphaGenome.

### Overlay View

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Overlay: 3 files | atac                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Track 0                                         â”‚
â”‚  [Blue line]   HG00120_rs10497191_H1            â”‚
â”‚  [Red line]    HG00120_rs10497191_H2            â”‚
â”‚  [Green line]  HG00121_rs10497191_H1            â”‚
â”‚                                                  â”‚
â”‚  Position (bp)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Multiple files superimposed with distinct colors for comparison.

### Group View (Stacked)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HG00120 | rs10497191 | H1 | GRUPO              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ATAC                       Î¼=0.1234 Ïƒ=0.0567  â”‚
â”‚  [Line plot]                                     â”‚
â”‚                                                  â”‚
â”‚  RNA_SEQ                    Î¼=0.3456 Ïƒ=0.0789  â”‚
â”‚  [Line plot]                                     â”‚
â”‚                                                  â”‚
â”‚  Position (bp)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Different output types displayed vertically for comparison.

### Group View (Overlaid)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HG00120 | rs10497191 | H1 | GRUPO (Overlaid)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Blue line - ATAC]    [Blue Y-axis on left]   â”‚
â”‚  [Red line - RNA_SEQ]  [Red Y-axis on right]   â”‚
â”‚                                                  â”‚
â”‚  Position (bp)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Different output types on the same plot with independent Y-axes.

## ğŸ“ File Organization

The visualizer automatically discovers files in this structure:

```
non_longevous_results/
â””â”€â”€ individuals/
    â”œâ”€â”€ HG00120/
    â”‚   â””â”€â”€ windows/
    â”‚       â”œâ”€â”€ rs10497191/
    â”‚       â”‚   â”œâ”€â”€ predictions_H1/
    â”‚       â”‚   â”‚   â”œâ”€â”€ atac.npz      â† Visualized
    â”‚       â”‚   â”‚   â””â”€â”€ rna_seq.npz   â† Visualized
    â”‚       â”‚   â””â”€â”€ predictions_H2/
    â”‚       â”‚       â”œâ”€â”€ atac.npz      â† Visualized
    â”‚       â”‚       â””â”€â”€ rna_seq.npz   â† Visualized
    â”‚       â””â”€â”€ rs2042762/
    â”‚           â””â”€â”€ ...
    â””â”€â”€ HG00121/
        â””â”€â”€ ...
```

Files are listed in the order they are found and can be filtered by output type.

## ğŸ¨ Color Palette

The overlay mode uses a carefully selected color palette for maximum contrast:

1. **Blue** (#1f77b4) - First file
2. **Red** (#d62728) - Second file âœ¨
3. **Green** (#2ca02c) - Third file
4. **Orange** (#ff7f0e) - Fourth file
5. **Purple** (#9467bd) - Fifth file
6. **Brown** (#8c564b)
7. **Pink** (#e377c2)
8. **Gray** (#7f7f7f)
9. **Yellow-green** (#bcbd22)
10. **Cyan** (#17becf)

Colors cycle if more than 10 files are overlaid.

## ğŸ’¡ Usage Examples

### Example 1: Compare Haplotypes

View predictions for both haplotypes of the same SNP:

1. Start the visualizer
2. Navigate to a file showing H1 predictions
3. Press `a` to activate overlay (adds H1)
4. Press `Space` to advance (if next file is H2, it will be added)
5. Now you're comparing H1 vs H2 predictions!

### Example 2: Compare Multiple Samples

View the same SNP across different individuals:

1. Navigate to sample 1, SNP X, haplotype H1
2. Press `a` to start overlay
3. Press `Space` multiple times to add more samples
4. See population-level variation in functional predictions

### Example 3: View All Output Types

See ATAC and RNA-seq predictions together:

1. Navigate to any file
2. Press `g` to activate group mode (stacked view)
3. Press `g` again to switch to overlaid view
4. Use `Space` / `â†` to navigate while staying in group mode

### Example 4: Filter by Output Type

Focus on only RNA-seq predictions:

1. Start with default view (shows ATAC)
2. Press `d` to switch to RNA-seq
3. Navigate with `Space` / `â†` through only RNA-seq files
4. Press `d` again to cycle back to ATAC

## ğŸ”§ Configuration

The visualizer reads the output directory from your YAML config:

```yaml
project:
  output_dir: "/path/to/non_longevous_results"
```

Make sure this path matches where your predictions are stored.

## ğŸ“ˆ Data Format

### .npz File Structure

AlphaGenome predictions are saved as NumPy arrays:

```python
import numpy as np

data = np.load('atac.npz')
print(data.files)  # ['track_0', 'track_1', 'track_2', ...]

track = data['track_0']  # Shape: (1048576,) for 1 Mb window
```

### Statistics Calculation

The visualizer calculates statistics in real-time:

- **Mean (Î¼)**: Average signal across all base pairs
- **Standard Deviation (Ïƒ)**: Signal variability

These are computed using NumPy's `np.mean()` and `np.std()` functions and are **NOT** stored in the .npz files.

## ğŸ› Troubleshooting

### Issue: Window disappears when pressing Space

**Solution**: This should be fixed in the latest version. If it still happens, make sure you're running with Python 3.8+ and matplotlib is properly installed.

### Issue: No files found

```
ValueError: No .npz files found in /path/to/output
```

**Solution**: 
- Verify the `output_dir` in your YAML config
- Make sure predictions have been generated (run pipeline with `predict: true`)
- Check that .npz files exist: `find non_longevous_results -name "*.npz"`

### Issue: Colors are too similar

**Solution**: The current version uses high-contrast colors (blue, red, green, etc.). If you still find them similar, this may be due to monitor calibration or color blindness. The colors can be customized in the source code (line ~390).

### Issue: Too many tracks displayed

The visualizer limits display to 4 tracks per file for performance. If you need to see more tracks, you can modify the limit in the source code:

```python
# Line ~330 and ~386
n_tracks = min(4, data.shape[1])  # Change 4 to desired number
```

### Issue: Program freezes

**Solution**: Large datasets (>10 overlaid files) may be slow to render. Try:
- Reducing the number of overlaid files (press `A` to clear)
- Closing other applications
- Using a machine with more RAM

## ğŸ“Š Performance Tips

1. **Use caching**: Files are cached after first load - navigating back is fast
2. **Limit overlays**: 3-5 overlaid files is optimal for visualization
3. **Filter by type**: Use `d`/`D` to view only relevant output types
4. **Close when done**: Press `q` to properly close and free memory

## ğŸ”— Integration with Pipeline

This visualizer is designed to work seamlessly with the non-longevous dataset pipeline:

1. **Generate predictions**: Run `build_non_longevous_dataset.py` with predictions enabled
2. **Visualize results**: Use this tool to explore the generated .npz files
3. **Quality check**: Verify predictions look reasonable before downstream analysis
4. **Compare populations**: Use overlay mode to compare functional variation

## ğŸ“š See Also

- **[AlphaGenome Predictions Guide](ALPHAGENOME_PREDICTIONS.md)** - How predictions are generated
- **[PyTorch Dataset Guide](PYTORCH_DATASET.md)** - Loading predictions for ML training
- **[AISNP Mode Guide](AISNP_MODE.md)** - Ancestry-informative SNP analysis
- **[Complete Structure Guide](STRUCTURE.md)** - Output directory organization

## ğŸ“ Author

Created for Alberto F. De Souza  
Last updated: 2025-11-13

