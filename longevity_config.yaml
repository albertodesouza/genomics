# ═══════════════════════════════════════════════════════════════════
# Configuration — Neural Longevity Dataset Builder
# ═══════════════════════════════════════════════════════════════════

project:
  name: "longevity_markers"
  description: "Discovery of longevity-associated genetic and epigenetic markers"
  output_dir: "longevity_dataset"

# ═══════════════════════════════════════════════════════════════════
# Data Sources
# ═══════════════════════════════════════════════════════════════════

data_sources:
  # Reference genome (first resolved relative to /dados/GENOMICS_DATA/top3/)
  reference:
    # fasta: "refs/reference.fa"   # falls back to this YAML directory/current cwd if needed
    fasta: "refs/GRCh38_full_analysis_set_plus_decoy_hla.fa"   # Correct reference for 1000 Genomes VCFs
    name: "GRCh38"

  # Download mode: "vcf_multisample" (cromossomos completos, RECOMENDADO) ou "cram" (indivíduos)
  download_mode: "vcf_multisample"  # DEFAULT - usa VCFs filtrados por cromossomo (3,202 amostras)
  
  # VCF multi-sample source (usado quando download_mode = "vcf_multisample")
  vcf_multisample_source:
    # IGSR 1000 Genomes High Coverage - VCFs filtrados e faseados por cromossomo
    base_url: "http://ftp.1000genomes.ebi.ac.uk/vol1/ftp/data_collections/1000G_2504_high_coverage/working/20220422_3202_phased_SNV_INDEL_SV/"
    # Padrão de nome dos arquivos por cromossomo (Nota: chrX tem .v2 - tratado automaticamente)
    filename_pattern: "1kGP_high_coverage_Illumina.{chrom}.filtered.SNV_INDEL_SV_phased_panel.vcf.gz"
    # Cromossomos a baixar (para teste, use apenas chr21, chr22 que são menores)
    # chromosomes: ["chr21", "chr22"]  # Teste com cromossomos pequenos
    chromosomes: ["chr1",  "chr2",  "chr3",  "chr4",  "chr5",  "chr6",  "chr7",  "chr8",  "chr9",  "chr10", 
                  "chr11", "chr12", "chr13", "chr14", "chr15", "chr16", "chr17", "chr18", "chr19", "chr20", 
                  "chr21", "chr22", "chrX"]  # Todos
    # Para produção, use todos: ["chr1", "chr2", ..., "chr22", "chrX"]
  
  # Configuração de amostragem de variantes (modo vcf_multisample)
  variant_sampling:
    # Número de variantes a extrair por cromossomo
    n_variants_per_chromosome: 3
    # Método de seleção: "sequential" (primeiras N - RÁPIDO) ou "random" (aleatórias - LENTO)
    selection_method: "sequential"  # Recomendado: sequential é instantâneo
    # Seed para reprodutibilidade (quando random)
    random_seed: 42
    # Mostrar contagem de variantes por cromossomo (lento: ~1-2 min para 23 cromossomos)
    show_variant_counts: false  # Default: false (pula contagem para ser mais rápido)
    # Variantes Disponíveis por Cromossomo:
    # ──────────────────────────────────────────────────────────────────────
    #    chr1:    5.759.060 variantes  █████████████████████████████████████
    #    chr2:    6.088.598 variantes  ████████████████████████████████████████
    #    chr3:    4.983.185 variantes  ████████████████████████████████
    #    chr4:    4.875.465 variantes  ████████████████████████████████
    #    chr5:    4.536.819 variantes  █████████████████████████████
    #    chr6:    4.315.217 variantes  ████████████████████████████
    #    chr7:    4.137.254 variantes  ███████████████████████████
    #    chr8:    3.886.222 variantes  █████████████████████████
    #    chr9:    3.165.513 variantes  ████████████████████
    #   chr10:    3.495.473 variantes  ██████████████████████
    #   chr11:    3.423.341 variantes  ██████████████████████
    #   chr12:    3.332.788 variantes  █████████████████████
    #   chr13:    2.509.179 variantes  ████████████████
    #   chr14:    2.290.400 variantes  ███████████████
    #   chr15:    2.109.285 variantes  █████████████
    #   chr16:    2.362.361 variantes  ███████████████
    #   chr17:    2.073.624 variantes  █████████████
    #   chr18:    1.963.845 variantes  ████████████
    #   chr19:    1.670.692 variantes  ██████████
    #   chr20:    1.644.384 variantes  ██████████
    #   chr21:    1.002.753 variantes  ██████
    #   chr22:    1.066.557 variantes  ███████
    #    chrX:    2.862.781 variantes  ██████████████████
    # ──────────────────────────────────────────────────────────────────────
    # TOTAL:   73.554.796 variantes

    # Filtros de qualidade (não usados - VCFs já filtrados)
    min_quality: 30
    only_pass: true
  
  # CRAM source (usado quando download_mode = "cram")
  cram_source:
    ena_project: "PRJEB31736"
    # ENA API será consultada para CRAM URLs

  # Configuração de indivíduos (usado apenas no modo CRAM)
  longevous:
    sample_range: [0, 4]         # inclusive start, exclusive end
    label: 1                     # class label for longevous individuals

  non_longevous:
    sample_range: [10, 14]       # inclusive start, exclusive end
    label: 0                     # class label for non-longevous individuals

# ═══════════════════════════════════════════════════════════════════
# Variant Selection
# ═══════════════════════════════════════════════════════════════════

variant_selection:
  # Strategy used to seed central points. Options: first_longevous_sample, random_rotation_longevous_samples
  initial_strategy: "random_rotation_longevous_samples"
  # Optional seed for strategies that rely on randomness (e.g., random_rotation_longevous_samples)
  random_seed: 13
  # Number of loci to extract around the seed variants
  n_central_points: 10
  filters:
    # Minimum QUAL accepted for a variant
    min_quality: 30
    # Minimum depth (DP) required at the variant site
    min_depth: 10
    # Only retain variants marked as PASS in the FILTER column
    filter_pass_only: true
    # Skip variants with high population allele frequency
    exclude_common: true
    max_allele_frequency: 0.5
  refinement:
    # Post-processing refinement is disabled by default
    enabled: false
    method: "importance_ranking"
    top_k: 50

# ═══════════════════════════════════════════════════════════════════
# Sequence Extraction
# ═══════════════════════════════════════════════════════════════════

sequence_extraction:
  # Window length around each central point (must match AlphaGenome supported sizes)
  window_size: 2048
  # Ensure the variant is positioned in the middle of the window
  center_on_variant: true
  # Replace the reference allele with the alternate allele in the FASTA sequence
  use_alternate_allele: true

# ═══════════════════════════════════════════════════════════════════
# AlphaGenome
# ═══════════════════════════════════════════════════════════════════

alphagenome:
  # API token expected in the environment (or override in CI)
  api_key: "${ALPHAGENOME_API_KEY}"
  outputs:
    - "RNA_SEQ"
    - "CAGE"
    - "ATAC"
    - "CHIP_HISTONE"
    - "CHIP_TF"
    - "DNASE"
    - "PROCAP"
  ontology_terms:
    - "UBERON:0000955"  # Brain
    - "UBERON:0002107"  # Liver
    - "UBERON:0000948"  # Heart
    - "UBERON:0002048"  # Lung
    - "UBERON:0002113"  # Kidney
  # Cache AlphaGenome responses to avoid repeated network calls
  cache_results: true
  cache_dir: "alphagenome_cache"
  # Batch prediction parameters and retry policy
  batch_size: 10
  max_retries: 3
  retry_delay: 5

# ═══════════════════════════════════════════════════════════════════
# Dataset Assembly
# ═══════════════════════════════════════════════════════════════════

dataset:
  # Proportions used when generating train/validation/test splits
  splits:
    train: 0.6
    validation: 0.2
    test: 0.2
  # Enforce balanced class counts per split
  balance_classes: true
  # Seed to ensure reproducible shuffling and splits
  random_seed: 42
  features:
    sequence:
      # Encode nucleotide sequences as one-hot tensors
      enabled: true
      encoding: "one_hot"
    position:
      # Include normalized genomic coordinates as features
      enabled: true
      normalize: true
    alphagenome_predictions:
      # Summaries derived from AlphaGenome predictions
      enabled: true
      aggregation: "statistics"
      statistics: ["mean", "std", "min", "max", "median"]
    metadata:
      # Additional contextual information stored alongside each example
      enabled: true
      fields:
        - "sample_id"
        - "chromosome"
        - "position"
        - "ref_allele"
        - "alt_allele"
        - "variant_type"
        - "genotype"
        - "allele_used"
  transforms:
    # Data augmentation hooks (disabled by default for genomics)
    enabled: false
    methods: []

# ═══════════════════════════════════════════════════════════════════
# Pipeline Execution
# ═══════════════════════════════════════════════════════════════════

pipeline:
  # High-level pipeline toggles (disable steps to resume from mid-process)
  steps:
    download_samples: true
    select_central_points: true
    extract_sequences: true
    run_alphagenome: false
    build_dataset: false
  parallel:
    # Worker pool used for CPU-bound steps (downloads, variant parsing)
    enabled: true
    n_workers: 4
  # Allow reruns to pick up from the last saved state
  resume_from_checkpoint: true
  # Persist progress every N processed samples
  checkpoint_frequency: 10

# ═══════════════════════════════════════════════════════════════════
# Resource Management
# ═══════════════════════════════════════════════════════════════════

resources:
  # Soft limits for local resource planners
  max_memory_gb: 32
  max_disk_gb: 100
  temp_dir: "/tmp/longevity_processing"

# ═══════════════════════════════════════════════════════════════════
# Logging & Debug
# ═══════════════════════════════════════════════════════════════════

logging:
  # Log verbosity and destinations
  level: "INFO"
  log_file: "longevity_dataset/processing.log"
  console_output: true

debug:
  # Developer conveniences for partial or exploratory runs
  dry_run: false
  limit_samples: null
  save_intermediate: true
